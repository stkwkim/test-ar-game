<!DOCTYPE html>
<html>
<head>
    <title>GPS-è§¸ç™¼å¯é¸å½±ç‰‡ + è·é›¢æç¤ºç‰ˆ</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{font-family:Arial, sans-serif;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:white}
        .container{max-width:600px;margin:0 auto;background:white;color:#333;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
        h1{text-align:center;color:#667eea;margin-bottom:30px}
        .location-card{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px 0;border-left:5px solid #667eea}
        .btn{background:#667eea;color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:16px;margin:5px}
        .btn:hover{background:#5a6fd8}
        .btn-success{background:#28a745}
        .btn-hint{background:#ffc107;color:black}
        .btn-video{background:#dc3545}
        .btn-story{background:#17a2b8}
        .btn-dev{background:#6c757d}
        input{width:100%;padding:12px;margin:10px 0;border:2px solid #ddd;border-radius:8px;font-size:16px}
        .completion{background:#d4edda;color:#155724;padding:30px;border-radius:10px;text-align:center;margin:20px 0;display:none}
        .progress-container{text-align:center;margin:20px 0;font-weight:bold}
        .progress-bar{width:100%;height:20px;background:#e9ecef;border-radius:10px;margin:10px 0;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,#28a745,#20c997);width:0%;transition:width .5s ease}
        .progress-text{display:flex;justify-content:space-between;margin-top:5px}
        /* ---- æ–°ï¼šGPS å¯é¸å½±ç‰‡æç¤º ---- */
        .gps-prompt{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#fff;color:#333;padding:15px 20px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.3);z-index:9999;display:none}
        .gps-prompt button{margin:0 5px}
        /* ---- æ–°ï¼šè·é›¢æ¨™ç±¤ ---- */
        .distance-badge{background:#e7f3ff;color:#004085;padding:4px 8px;border-radius:4px;font-size:.85em;margin-left:8px}
        /* ---- å…¨å±å½±ç‰‡ ---- */
        .gps-video-overlay{position:fixed;inset:0;background:#000;display:none;z-index:9999}
        .gps-video-overlay iframe{width:100%;height:100%;border:none}
    </style>
<base target="_blank">
</head>
<body>
    <div class="container">
        <h1>ğŸ›ï¸ ä¹é¾åŸåœŸç“œç£æ¢ç´¢<br><small>GPS-å¯é¸å½±ç‰‡ + è·é›¢æç¤ºç‰ˆ</small></h1>

        <div class="progress-container">
            <div>æ¢ç´¢é€²åº¦: <span id="progress-count">1</span>/6</div>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            <div class="progress-text">
                <span>å·²å®Œæˆ: <span id="progress-percent">17</span>%</span>
                <span>å‰©é¤˜: <span id="remaining-percent">83</span>%</span>
            </div>
        </div>

        <!-- ===== åœ°é» 1~6 å¡ç‰‡ï¼ˆç”± JS ç”Ÿæˆï¼‰ ===== -->
        <div id="cards-area"></div>

        <!-- ===== GPS å¯é¸å½±ç‰‡æç¤º ===== -->
        <div id="gpsPrompt" class="gps-prompt">
            <div>ğŸ“ ä½ å·²åˆ°é” <strong id="promptPoiName"></strong>ï¼</div>
            <div style="margin-top:8px">
                <button class="btn btn-story" onclick="playSelected('story')">æ’­æ”¾æ•…äº‹é€²åº¦</button>
                <button class="btn btn-video" onclick="playSelected('hist')">æ’­æ”¾æ­·å²ç‰‡æ®µ</button>
                <button class="btn" onclick="closePrompt()">ç¨å¾Œå†èªª</button>
            </div>
        </div>

        <!-- ===== å…¨å±å½±ç‰‡ ===== -->
        <div id="gpsVideo" class="gps-video-overlay">
            <iframe id="gpsPlayer" allow="autoplay" allowfullscreen></iframe>
        </div>

        <!-- ===== é–‹ç™¼è€…å·¥å…· ===== -->
        <div class="dev-tools" style="margin-top:30px;padding:15px;background:#e9ecef;border-radius:8px">
            <h3>ğŸ”§ é–‹ç™¼è€…å·¥å…·</h3>
            <div class="button-group">
                <button class="btn btn-dev" onclick="skipToLocation(1)">åœ°é»1</button>
                <button class="btn btn-dev" onclick="skipToLocation(2)">åœ°é»2</button>
                <button class="btn btn-dev" onclick="skipToLocation(3)">åœ°é»3</button>
                <button class="btn btn-dev" onclick="skipToLocation(4)">åœ°é»4</button>
                <button class="btn btn-dev" onclick="skipToLocation(5)">åœ°é»5</button>
                <button class="btn btn-dev" onclick="skipToLocation(6)">åœ°é»6</button>
                <button class="btn btn-success" onclick="completeGame()">ç›´æ¥å®Œæˆ</button>
            </div>
        </div>
    </div>

    <script>
    /* ================= é¡Œç›®è³‡æ–™ ================= */
    const POIS = [
        {id:1, name:'ä¹é¾å¯¨åŸå…¬åœ’',  lat:22.317212 + 0.00080, lng:114.167039 + 0.00080, answer:'è¡™é–€'},
        {id:2, name:'åä¸‰è¡—èˆŠæ¨“ç¾¤', lat:22.317212 - 0.00090, lng:114.167039 + 0.00090, answer:'1950'},
        {id:3, name:'ç‰›æ£šè—è¡“æ‘',   lat:22.317212 + 0.00100, lng:114.167039 - 0.00070, answer:'å± å®°å ´'},
        {id:4, name:'æµ·å¿ƒå…¬åœ’',     lat:22.317212 - 0.00110, lng:114.167039 - 0.00060, answer:'é­šå°¾çŸ³'},
        {id:5, name:'å®‹çš‡è‡ºå…¬åœ’',   lat:22.317212 + 0.00120, lng:114.167039 + 0.00120, answer:'å—å®‹'},
        {id:6, name:'ç´…ç£¡è§€éŸ³å»Ÿ',   lat:22.317212 - 0.00130, lng:114.167039 + 0.00130, answer:'è§€éŸ³'}
    ];
    const VIDEOS = {   // ç•™ä½ï¼Œæ›æˆä½ çš„ YouTube ID
        1: {story:'dQw4w9WgXcQ', hist:'dQw4w9WgXcQ'},
        2: {story:'AAA', hist:'BBB'},
        3: {story:'CCC', hist:'DDD'},
        4: {story:'EEE', hist:'FFF'},
        5: {story:'GGG', hist:'HHH'},
        6: {story:'III', hist:'JJJ'}
    };

    let currentLocation = 1, totalLocations = 6;
    const hintCounters = {1:0,2:0,3:0,4:0,5:0,6:0};
    let distCache      = {};   // æ¯é»è·é›¢æš«å­˜
    let promptShownSet = new Set(); // æ¯é»åªå½ˆä¸€æ¬¡æç¤º

    /* ================= ç”Ÿæˆ 6 å¼µå¡ç‰‡ ================= */
    function buildCards(){
        const area = document.getElementById('cards-area');
        POIS.forEach((p,i)=>{
            area.insertAdjacentHTML('beforeend', `
            <div id="location-${p.id}" class="location-card" style="${i?'display:none':''}">
                <h2>ğŸ“ ${p.name}<span id="dist-${p.id}" class="distance-badge">è¨ˆç®—ä¸­â€¦</span></h2>
                <p><strong>æ•…äº‹:</strong> é€™è£¡æ˜¯â€¦â€¦ï¼ˆç•¥ï¼‰</p>
                <p><strong>å•é¡Œ:</strong> ${p.name}â€¦â€¦ï¼Ÿ</p>
                <input id="answer-${p.id}" placeholder="è¼¸å…¥ç­”æ¡ˆ">
                <div style="margin-top:10px">
                    <button class="btn" onclick="checkAnswer(${p.id},'${p.answer}')">æäº¤ç­”æ¡ˆ</button>
                    <button class="btn btn-hint" onclick="showHint(${p.id})">ğŸ’¡ æç¤º (<span id="hint-count-${p.id}">0</span>/3)</button>
                </div>
            </div>`);
        });
    }
    buildCards();

    /* ================= å•ç­”é‚è¼¯ ================= */
    function checkAnswer(n,ans){
        if(document.getElementById('answer-'+n).value.trim().includes(ans)){
            alert('âœ… æ­£ç¢ºï¼'); document.getElementById('location-'+n).style.display='none';
            currentLocation++; updateProgress();
            if(currentLocation<=totalLocations) document.getElementById('location-'+currentLocation).style.display='block';
            else completeGame();
        }else alert('âŒ å†è©¦è©¦');
    }
    function showHint(n){
        const hints=['ç­”æ¡ˆå°±åœ¨å•é¡Œè£¡ï¼','å†æƒ³æƒ³â€¦','ç­”æ¡ˆæ˜¯ï¼šè¡™é–€ï¼1950ï¼å± å®°å ´ï¼é­šå°¾çŸ³ï¼å—å®‹ï¼è§€éŸ³'.split('/')[n-1]];
        alert(hints[Math.min(hintCounters[n]++,2)]);
        document.getElementById('hint-count-'+n).textContent=hintCounters[n];
    }
    function updateProgress(){
        const pc = Math.min(((currentLocation-1)/totalLocations)*100,100);
        document.getElementById('progress-count').textContent = currentLocation-1;
        document.getElementById('progress-percent').textContent  = Math.round(pc);
        document.getElementById('remaining-percent').textContent = Math.round(100-pc);
        document.getElementById('progress-fill').style.width = pc+'%';
    }
    updateProgress();

    /* ================= GPS è·é›¢ + å¯é¸å½±ç‰‡ ================= */
    const TRIGGER_M = 200;   // æ¸¬è©¦åŠå¾‘ï¼Œä¸Šç·šæ”¹ 30
    const player   = document.getElementById('gpsPlayer');
    const overlay  = document.getElementById('gpsVideo');
    const prompt = document.getElementById('gpsPrompt');
    let   pendingType = ''; // ç”¨æˆ¶é¸äº†å“ªç‰‡

    function dist(a,b){
        const R=6371000, toRad=d=>d*Math.PI/180, dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
        const la1=toRad(a.lat), la2=toRad(b.lat);
        return 2*R*Math.asin(Math.sqrt(Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLng/2)**2));
    }
    function closePrompt(){ prompt.style.display='none'; }
    function playSelected(type){
        pendingType = type;
        const id = Number(prompt.dataset.poiId);
        overlay.style.display='block';
        player.src = `https://www.youtube.com/embed/${VIDEOS[id][type]}?autoplay=1&rel=0`;
        closePrompt();
        // 20 ç§’å¾Œè‡ªå‹•é—œé–‰
        setTimeout(()=>{ overlay.style.display='none'; player.src=''; },20000);
    }
    function watchGPS(){
        navigator.geolocation.watchPosition(
            pos=>{
                const here={lat:pos.coords.latitude, lng:pos.coords.longitude};
                POIS.forEach(p=>{
                    const d = Math.round(dist(here,p));
                    distCache[p.id] = d;
                    const badge = document.getElementById('dist-'+p.id);
                    if(badge) badge.textContent = d<1000 ? d+' m' : (d/1000).toFixed(1)+' km';

                    if(d<TRIGGER_M && !promptShownSet.has(p.id)){
                        promptShownSet.add(p.id);
                        prompt.dataset.poiId = p.id;
                        document.getElementById('promptPoiName').textContent = p.name;
                        prompt.style.display='block';
                    }
                });
            },
            err=>console.warn('GPS éŒ¯èª¤:',err),
            {enableHighAccuracy:true, maximumAge:5000}
        );
    }
    window.addEventListener('load',()=>{
        if(navigator.geolocation) watchGPS();
        else alert('è£ç½®ä¸æ”¯æ´ GPSï¼Œç„¡æ³•ä½¿ç”¨è·é›¢èˆ‡å½±ç‰‡æç¤ºã€‚');
    });
    </script>
</body>
</html>
