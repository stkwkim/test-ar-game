<!DOCTYPE html>
<html>
<head>
    <title>ä¹é¾åŸåœŸç“œç£æ¢ç´¢ï¼ˆES5 ç›¸å®¹ç‰ˆï¼‰</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:.5rem;color:#fff}
        .container{width:100%;max-width:500px;background:#fff;color:#333;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.18);padding:1.25rem}
        h1{text-align:center;margin:0 0 1rem 0;font-size:1.5rem;background:-webkit-linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .progress-container{text-align:center;margin-bottom:1rem;font-size:.875rem}
        .progress-bar{height:.5rem;background:#e9ecef;border-radius:1rem;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,#28a745,#20c997);width:0%;transition:width .5s ease}
        .progress-text{display:flex;justify-content:space-between;margin-top:.25rem;font-size:.75rem}
        .location-card{background:#f8f9fa;padding:1rem;border-left:4px solid #667eea;border-radius:8px;margin-bottom:.75rem}
        .btn{background:#667eea;color:#fff;border:none;padding:.5rem .75rem;border-radius:6px;font-size:.875rem;cursor:pointer;margin:.2rem;transition:background .3s}
        .btn:hover{background:#5a6fd8}.btn-success{background:#28a245}.btn-hint{background:#ffc107;color:#000}.btn-video{background:#dc3545}.btn-story{background:#17a2b8}
        input{width:100%;padding:.5rem;border:2px solid #ddd;border-radius:6px;font-size:.875rem;margin:.4rem 0}
        .selfie-box{text-align:center;margin-top:.5rem}.selfie-canvas{display:none}.selfie-img{width:120px;margin-top:.5rem;border-radius:6px}
        .distance-badge{background:#e7f3ff;color:#004085;padding:.2rem .4rem;border-radius:4px;font-size:.75rem;margin-left:.4rem}
        .poem-mask{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.25rem;text-align:center;padding:2rem;z-index:9999}
        .poem-mask p{margin:0 0 1.5rem 0;letter-spacing:1px}
        .gps-prompt{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#fff;color:#333;padding:12px 16px;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.25);z-index:9999;display:none;font-size:.875rem}
        .gps-prompt button{margin:0 4px}.gps-video-overlay{position:fixed;inset:0;background:#000;display:none;z-index:9999}
        .gps-video-overlay iframe{width:100%;height:100%;border:none}
        .qr-code{text-align:center;margin:1rem 0}.qr-code img{width:140px;height:140px}.qr-instruction{font-size:.75rem;color:#555;margin-top:.5rem}
        @media (min-width:600px){h1{font-size:1.75rem}.poem-mask{font-size:1.5rem}}
    </style>
<base target="_blank">
</head>
<body>
<div class="container">
    <h1>ğŸ›ï¸ ä¹é¾åŸåœŸç“œç£æ¢ç´¢</h1>
    <div class="progress-container">
        <div>æ¢ç´¢é€²åº¦ï¼š<span id="progress-count">0</span> / 6</div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <div class="progress-text">
            <span>å·²å®Œæˆï¼š<span id="progress-percent">0</span>%</span>
            <span>å‰©é¤˜ï¼š<span id="remaining-percent">100</span>%</span>
        </div>
    </div>

    <!-- é¡Œç›®1 -->
    <div id="location-1" class="location-card">
        <h2>ğŸ“ ä¹é¾å¯¨åŸå…¬åœ’<span id="dist-1" class="distance-badge">è¨ˆç®—ä¸­â€¦</span></h2>
        <p><strong>æ•…äº‹ï¼š</strong>é€™è£¡æ›¾æ˜¯å……æ»¿å‚³å¥‡çš„ä¹é¾å¯¨åŸï¼Œä¸€å€‹åœ¨ä¸‰ä¸ç®¡åœ°å¸¶ä¸­è‡ªç„¶å½¢æˆçš„ç¨ç‰¹ç¤¾å€ã€‚</p>
        <div class="button-group">
            <button class="btn btn-video" onclick="showVideo(1,'history')">ğŸ¬ æ­·å²å½±ç‰‡</button>
            <button class="btn btn-story" onclick="showVideo(1,'story')">ğŸ“– æ•…äº‹é€²åº¦</button>
        </div>
        <p><strong>å•é¡Œï¼š</strong>ä¹é¾å¯¨åŸå…¬åœ’ä¿ç•™äº†æ¸…ä»£è¡™é–€çš„å“ªå€‹é‡è¦å»ºç¯‰çµæ§‹ï¼Ÿ</p>
        <input type="text" id="answer-1" placeholder="è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ">
        <div class="button-group">
            <button class="btn" onclick="checkAnswer(1,'è¡™é–€')">æäº¤ç­”æ¡ˆ</button>
            <button class="btn btn-hint" onclick="showHint(1)">ğŸ’¡ æç¤º (<span id="hint-count-1">0</span>/3)</button>
        </div>
        <div class="selfie-box">
            <button class="btn btn-success" onclick="takeSelfie(1)">ğŸ“¸ è‡ªæ‹åˆ†äº«</button>
            <canvas id="canvas-1" class="selfie-canvas" width="600" height="600"></canvas>
            <img id="selfie-1" class="selfie-img" style="display:none;">
        </div>
    </div>

    <!-- é¡Œç›®2 -->
    <div id="location-2" class="location-card" style="display:none">
        <h2>ğŸ¢ åä¸‰è¡—èˆŠæ¨“ç¾¤<span id="dist-2" class="distance-badge">è¨ˆç®—ä¸­â€¦</span></h2>
        <p><strong>æ•…äº‹ï¼š</strong>åä¸‰è¡—è¦‹è­‰äº†åœŸç“œç£çš„å·¥æ¥­ç™¼å±•å²ï¼Œæˆ°å‰é¨æ¨“èåˆä¸­è¥¿é¢¨æ ¼ã€‚</p>
        <div class="button-group">
            <button class="btn btn-video" onclick="showVideo(2,'history')">ğŸ¬ æ­·å²å½±ç‰‡</button>
            <button class="btn btn-story" onclick="showVideo(2,'story')">ğŸ“– æ•…äº‹é€²åº¦</button>
        </div>
        <p><strong>å•é¡Œï¼š</strong>åä¸‰è¡—çš„é¨æ¨“å»ºç¯‰ä¸»è¦å»ºæ–¼å“ªå€‹å¹´ä»£ï¼Ÿï¼ˆå››ä½æ•¸å­—ï¼‰</p>
        <input type="text" id="answer-2" placeholder="è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ">
        <div class="button-group">
            <button class="btn" onclick="checkAnswer(2,'1950')">æäº¤ç­”æ¡ˆ</button>
            <button class="btn btn-hint" onclick="showHint(2)">ğŸ’¡ æç¤º (<span id="hint-count-2">0</span>/3)</button>
        </div>
        <div class="selfie-box">
            <button class="btn btn-success" onclick="takeSelfie(2)">ğŸ“¸ è‡ªæ‹åˆ†äº«</button>
            <canvas id="canvas-2" class="selfie-canvas" width="600" height="600"></canvas>
            <img id="selfie-2" class="selfie-img" style="display:none;">
        </div>
    </div>

    <!-- é¡Œç›®3 -->
    <div id="location-3" class="location-card" style="display:none">
        <h2>ğŸ¨ ç‰›æ£šè—è¡“æ‘<span id="dist-3" class="distance-badge">è¨ˆç®—ä¸­â€¦</span></h2>
        <p><strong>æ•…äº‹ï¼š</strong>1908 å¹´å»ºæˆçš„å¸‚å€å± å®°å ´ï¼Œæ´»åŒ–å¾Œæˆç‚ºè—è¡“å®¶å·¥ä½œå®¤èˆ‡å±•å ´ã€‚</p>
        <div class="button-group">
            <button class="btn btn-video" onclick="showVideo(3,'history')">ğŸ¬ æ­·å²å½±ç‰‡</button>
            <button class="btn btn-story" onclick="showVideo(3,'story')">ğŸ“– æ•…äº‹é€²åº¦</button>
        </div>
        <p><strong>å•é¡Œï¼š</strong>ç‰›æ£šè—è¡“æ‘çš„å‰èº«æ˜¯ä»€éº¼å»ºç¯‰ï¼Ÿï¼ˆä¸‰å€‹å­—ï¼‰</p>
        <input type="text" id="answer-3" placeholder="è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ">
        <div class="button-group">
            <button class="btn" onclick="checkAnswer(3,'å± å®°å ´')">æäº¤ç­”æ¡ˆ</button>
            <button class="btn btn-hint" onclick="showHint(3)">ğŸ’¡ æç¤º (<span id="hint-count-3">0</span>/3)</button>
        </div>
        <div class="selfie-box">
            <button class="btn btn-success" onclick="takeSelfie(3)">ğŸ“¸ è‡ªæ‹åˆ†äº«</button>
            <canvas id="canvas-3" class="selfie-canvas" width="600" height="600"></canvas>
            <img id="selfie-3" class="selfie-img" style="display:none;">
        </div>
    </div>

    <!-- é¡Œç›®4 -->
    <div id="location-4" class="location-card" style="display:none">
        <h2>ğŸŒŠ æµ·å¿ƒå…¬åœ’<span id="dist-4" class="distance-badge">è¨ˆç®—ä¸­â€¦</span></h2>
        <p><strong>æ•…äº‹ï¼š</strong>ä»¥é­šå°¾çŸ³èåï¼Œå¾å‰æ¼æ°‘åœ¨æ­¤ç¥ˆæ±‚å¹³å®‰ï¼Œåœ’å…§æœ‰é„­æˆåŠŸçŸ³åƒã€‚</p>
        <div class="button-group">
            <button class="btn btn-video" onclick="showVideo(4,'history')">ğŸ¬ æ­·å²å½±ç‰‡</button>
            <button class="btn btn-story" onclick="showVideo(4,'story')">ğŸ“– æ•…äº‹é€²åº¦</button>
        </div>
        <p><strong>å•é¡Œï¼š</strong>æµ·å¿ƒå…¬åœ’æœ€è‘—åçš„è‡ªç„¶æ™¯è§€æ˜¯ä»€éº¼çŸ³ï¼Ÿ</p>
        <input type="text" id="answer-4" placeholder="è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ">
        <div class="button-group">
            <button class="btn" onclick="checkAnswer(4,'é­šå°¾çŸ³')">æäº¤ç­”æ¡ˆ</button>
            <button class="btn btn-hint" onclick="showHint(4)">ğŸ’¡ æç¤º (<span id="hint-count-4">0</span>/3)</button>
        </div>
        <div class="selfie-box">
            <button class="btn btn-success" onclick="takeSelfie(4)">ğŸ“¸ è‡ªæ‹åˆ†äº«</button>
            <canvas id="canvas-4" class="selfie-canvas" width="600" height="600"></canvas>
            <img id="selfie-4" class="selfie-img" style="display:none;">
        </div>
    </div>

    <!-- é¡Œç›®5 -->
    <div id="location-5" class="location-card" style="display:none">
        <h2>ğŸ‘‘ å®‹çš‡è‡ºå…¬åœ’<span id="dist-5" class="distance-badge">è¨ˆç®—ä¸­â€¦</span></h2>
        <p><strong>æ•…äº‹ï¼š</strong>å—å®‹æœ€å¾Œå…©ä½çš‡å¸é€ƒé¿å…ƒè»ä¹‹åœ°ï¼Œã€Œå®‹çš‡è‡ºã€çŸ³åˆ»è¦‹è­‰é¦™æ¸¯å¤ä»Šã€‚</p>
        <div class="button-group">
            <button class="btn btn-video" onclick="showVideo(5,'history')">ğŸ¬ æ­·å²å½±ç‰‡</button>
            <button class="btn btn-story" onclick="showVideo(5,'story')">ğŸ“– æ•…äº‹é€²åº¦</button>
        </div>
        <p><strong>å•é¡Œï¼š</strong>å®‹çš‡è‡ºç´€å¿µçš„æ˜¯å“ªå€‹æœä»£çš„çš‡å¸ï¼Ÿï¼ˆå…©å€‹å­—ï¼‰</p>
        <input type="text" id="answer-5" placeholder="è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ">
        <div class="button-group">
            <button class="btn" onclick="checkAnswer(5,'å—å®‹')">æäº¤ç­”æ¡ˆ</button>
            <button class="btn btn-hint" onclick="showHint(5)">ğŸ’¡ æç¤º (<span id="hint-count-5">0</span>/3)</button>
        </div>
        <div class="selfie-box">
            <button class="btn btn-success" onclick="takeSelfie(5)">ğŸ“¸ è‡ªæ‹åˆ†äº«</button>
            <canvas id="canvas-5" class="selfie-canvas" width="600" height="600"></canvas>
            <img id="selfie-5" class="selfie-img" style="display:none;">
        </div>
    </div>

    <!-- é¡Œç›®6 -->
    <div id="location-6" class="location-card" style="display:none">
        <h2>ğŸ™ ç´…ç£¡è§€éŸ³å»Ÿ<span id="dist-6" class="distance-badge">è¨ˆç®—ä¸­â€¦</span></h2>
        <p><strong>æ•…äº‹ï¼š</strong>1873 å¹´å»ºæˆçš„é¦™æ¸¯äºŒç´šæ­·å²å»ºç¯‰ï¼Œç¤¾å€ä¿¡ä»°èˆ‡å‡èšæ ¸å¿ƒã€‚</p>
        <div class="button-group">
            <button class="btn btn-video" onclick="showVideo(6,'history')">ğŸ¬ æ­·å²å½±ç‰‡</button>
            <button class="btn btn-story" onclick="showVideo(6,'story')">ğŸ“– æ•…äº‹é€²åº¦</button>
        </div>
        <p><strong>å•é¡Œï¼š</strong>ç´…ç£¡è§€éŸ³å»Ÿä¸»è¦ä¾›å¥‰å“ªä½ç¥ç¥‡ï¼Ÿ</p>
        <input type="text" id="answer-6" placeholder="è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ">
        <div class="button-group">
            <button class="btn" onclick="checkAnswer(6,'è§€éŸ³')">æäº¤ç­”æ¡ˆ</button>
            <button class="btn btn-hint" onclick="showHint(6)">ğŸ’¡ æç¤º (<span id="hint-count-6">0</span>/3)</button>
        </div>
        <div class="selfie-box">
            <button class="btn btn-success" onclick="takeSelfie(6)">ğŸ“¸ è‡ªæ‹åˆ†äº«</button>
            <canvas id="canvas-6" class="selfie-canvas" width="600" height="600"></canvas>
            <img id="selfie-6" class="selfie-img" style="display:none;">
        </div>
    </div>

    <!-- å®Œæˆé  -->
    <div id="completion" class="completion" style="display:none;text-align:center;">
        <h2>ğŸ‰ æ­å–œæ‚¨å®Œæˆæ‰€æœ‰æ¢ç´¢ï¼</h2>
        <p>æ‚¨å·²æˆåŠŸå®Œæˆä¹é¾åŸåœŸç“œç£çš„ 6 å€‹æ­·å²åœ°é»æ¢ç´¢ï¼</p>
        <div class="qr-code">
            <h3>å®Œæˆçå‹µäºŒç¶­ç¢¼</h3>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=å®Œæˆ" alt="å®Œæˆçå‹µ">
            <p class="qr-instruction">æƒææ­¤äºŒç¶­ç¢¼å¯ç²å¾—æ•¸å­—ä»£ç¢¼</p>
        </div>
        <div class="selfie-box">
            <button class="btn btn-success" onclick="takeSelfie(0)">ğŸ“¸ è‡ªæ‹åˆ†äº«å®Œæˆä»»å‹™</button>
            <canvas id="canvas-0" class="selfie-canvas" width="600" height="600"></canvas>
            <img id="selfie-0" class="selfie-img" style="display:none;">
        </div>
        <button class="btn btn-success" onclick="resetGame()">é‡æ–°é–‹å§‹éŠæˆ²</button>
    </div>
</div>

<!-- å½±ç‰‡æ¨¡æ€æ¡† / GPS å¼¹çª— / å…¨å±å½±ç‰‡ -->
<div id="video-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:12px;padding:1rem;max-width:560px;width:90%;">
        <h2 id="video-title">å½±ç‰‡æ¨™é¡Œ</h2>
        <p id="video-description">å½±ç‰‡æè¿°</p>
        <div><iframe id="video-player" width="100%" height="315" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
        <p style="font-size:.75rem;color:#555;margin-top:.5rem;">åœ¨ARç‰ˆæœ¬ä¸­ï¼Œé€™æ®µå½±ç‰‡æœƒåœ¨æ‚¨åˆ°é”åœ°é»æ™‚è‡ªå‹•æ’­æ”¾ï¼Œä¸¦èˆ‡å¯¦æ™¯çµåˆ</p>
        <button class="btn" onclick="closeVideo()">é—œé–‰å½±ç‰‡</button>
    </div>
</div>
<div id="gpsPrompt" class="gps-prompt">
    <div>ğŸ“ ä½ å·²åˆ°é” <strong id="promptPoiName"></strong>ï¼</div>
    <div style="margin-top:8px">
        <button class="btn btn-story" onclick="playSelected('story')">æ’­æ”¾æ•…äº‹é€²åº¦</button>
        <button class="btn btn-video" onclick="playSelected('hist')">æ’­æ”¾æ­·å²ç‰‡æ®µ</button>
        <button class="btn" onclick="closePrompt()">ç¨å¾Œå†èªª</button>
    </div>
</div>
<div id="gpsVideo" class="gps-video-overlay"><iframe id="gpsPlayer" allow="autoplay" allowfullscreen></iframe></div>

<script>
/* ========== æ ¸å¿ƒæµç¨‹ï¼šES5 ç›¸å®¹ + ç­”å°æ‰éå ´ ========== */
let currentLocation = 1;
const totalLocations = 6;
const hintCounters = {1:0,2:0,3:0,4:0,5:0,6:0};

/* ---- ä¸‹ä¸€åœ°é»è©©æ„æç¤º ---- */
const nextPoem = {
  2:'ç£šç“¦ç–Šç–Šï¼Œæ­²æœˆæ–‘æ–‘ï¼›ä¸‹ä¸€é ï¼Œé¨æ¨“å°‡æŠŠèˆŠå¤¢ç¿»éŸ¿ã€‚',
  3:'éµé–˜èƒŒå¾Œï¼Œæ›¾ç¶“ç‰›è²ä½è¿´ï¼›ç´…ç£šå¾…ä½ ï¼ŒçºŒå¯«è—è¡“æ–°ç« ã€‚',
  4:'æµ·é¢¨è¼•æ‹‚ï¼Œé­šå°¾çŸ³ä»å®ˆæœ›ï¼›æµªèŠ±è¦æŠŠä¸‹ä¸€æ®µæ•…äº‹äº¤åˆ°ä½ æ‰‹ä¸Šã€‚',
  5:'å®‹å®¤éºç—•ï¼Œè‹”è˜šç”Ÿé¦™ï¼›è¸éçŸ³åˆ»ï¼Œå†è½ä¸€æ®µçš‡å®¤é¢¨éœœã€‚',
  6:'é¦™ç«ç¹šç¹ï¼Œè§€éŸ³ä½çœ‰ï¼›å»Ÿç°·ä¸‹çš„é¢¨éˆ´ï¼Œæ­£ç‚ºä½ ä½œéŸ¿ã€‚'
};

function updateProgress(){
  const pc = Math.min(((currentLocation-1)/totalLocations)*100,100);
  document.getElementById('progress-count').textContent = currentLocation-1;
  document.getElementById('progress-percent').textContent = Math.round(pc);
  document.getElementById('remaining-percent').textContent = Math.round(100-pc);
  document.getElementById('progress-fill').style.width = pc + '%';
}

/* âœ… åªæœ‰ç­”å°æ‰æœƒè¢«èª¿ç”¨ */
function showPoemThenNext(){
  document.getElementById('location-'+currentLocation).style.display='none';
  const wrap = document.createElement('div');
  wrap.id = 'poem-mask';
  wrap.className = 'poem-mask';
  wrap.innerHTML = 
    '<div>' +
      '<p>' + (nextPoem[currentLocation+1]||'') + '</p>' +
      '<button class="btn btn-success" onclick="goNextLocation()">ä¼°ä¸‹ä¸‹å€‹ä»»å‹™åœ°æ–¹</button>' +
    '</div>';
  document.body.appendChild(wrap);
}

function goNextLocation(){
  const mask = document.getElementById('poem-mask');
  if(mask) mask.remove();
  currentLocation++;
  updateProgress();
  if(currentLocation<=totalLocations){
    document.getElementById('location-'+currentLocation).style.display='block';
    // âœ… é‡ç½® GPS æç¤ºï¼Œè®“æ–°åœ°é»å¯ä»¥å†æ¬¡å½ˆå‡º
    promptShownSet.clear();
  }else{
    completeGame();
  }
}

/* âœ… åš´æ ¼æ¯”å°ï¼šåªæœ‰æ­£ç¢ºæ‰é€²å…¥è©©æ„éå ´ */
function checkAnswer(locationNum,correctAnswer){
  const userAnswer = document.getElementById('answer-'+locationNum).value.trim().toLowerCase();
  const correct = correctAnswer.toLowerCase();
  let isCorrect = false;
  
  // åš´æ ¼æ¯”å°é‚è¼¯
  if(userAnswer === correct) {
    isCorrect = true;
  }
  // é‡å°ç‰¹å®šé¡Œç›®çš„å¯¬é¬†æ¯”å°
  if(locationNum === 2 && (userAnswer === '50å¹´ä»£' || userAnswer === 'äº”åå¹´ä»£')) {
    isCorrect = true;
  }

  if(isCorrect){
    document.getElementById('answer-'+locationNum).value='';
    showPoemThenNext(); // åªæœ‰æ­£ç¢ºæ‰é¡¯ç¤ºè©©å¥
  }else{
    alert('âŒ ç­”æ¡ˆä¸æ­£ç¢ºï¼Œè«‹å†è©¦ä¸€æ¬¡æˆ–æŸ¥çœ‹æç¤ºã€‚');
  }
}

function showHint(locationNum){
  hintCounters[locationNum]++;
  document.getElementById('hint-count-'+locationNum).textContent=hintCounters[locationNum];
  const hints={
    1:{1:'æç¤ºï¼šç­”æ¡ˆå°±åœ¨å•é¡Œä¸­ï¼ç•™æ„ã€Œè¡™é–€ã€é€™å€‹è©ã€‚',2:'æç¤ºï¼šæ¸…ä»£è¡™é–€çš„é‡è¦å»ºç¯‰çµæ§‹å°±æ˜¯ã€Œè¡™é–€ã€æœ¬èº«ã€‚',3:'ç­”æ¡ˆï¼šè¡™é–€'},
    2:{1:'æç¤ºï¼šæƒ³æƒ³é¦™æ¸¯æˆ°å¾Œé‡å»ºçš„æ™‚æœŸï¼Œç­”æ¡ˆæ˜¯å››ä½æ•¸å­—ã€‚',2:'æç¤ºï¼š1950å¹´ä»£æ˜¯é¦™æ¸¯æˆ°å¾Œé‡å»ºçš„é‡è¦æ™‚æœŸã€‚',3:'ç­”æ¡ˆï¼š1950'},
    3:{1:'æç¤ºï¼šé€™å€‹åœ°æ–¹åŸæœ¬çš„ç”¨é€”èˆ‡ã€Œç‰›ã€æœ‰é—œï¼Œç­”æ¡ˆæ˜¯ä¸‰å€‹å­—ã€‚',2:'æç¤ºï¼šé€™è£¡åŸæœ¬æ˜¯è™•ç†ç‰›éš»çš„åœ°æ–¹ã€‚',3:'ç­”æ¡ˆï¼šå± å®°å ´'},
    4:{1:'æç¤ºï¼šç­”æ¡ˆå°±åœ¨å•é¡Œä¸­ï¼æ˜¯ä¸€ç¨®èˆ‡æµ·æ´‹ç”Ÿç‰©æœ‰é—œçš„çŸ³é ­ã€‚',2:'æç¤ºï¼šé€™ç¨®çŸ³é ­å½¢ç‹€åƒé­šçš„å°¾å·´ã€‚',3:'ç­”æ¡ˆï¼šé­šå°¾çŸ³'},
    5:{1:'æç¤ºï¼šæƒ³æƒ³ä¸­åœ‹æ­·å²ä¸­å—åŒ—å®‹çš„æ™‚æœŸï¼Œç­”æ¡ˆæ˜¯å…©å€‹å­—ã€‚',2:'æç¤ºï¼šå—å®‹æ˜¯å®‹æœçš„å¾ŒæœŸéšæ®µã€‚',3:'ç­”æ¡ˆï¼šå—å®‹'},
    6:{1:'æç¤ºï¼šç­”æ¡ˆå°±åœ¨å»Ÿå®‡åç¨±ä¸­ï¼',2:'æç¤ºï¼šè§€éŸ³å»Ÿä¸»è¦ä¾›å¥‰çš„å°±æ˜¯è§€éŸ³è©è–©ã€‚',3:'ç­”æ¡ˆï¼šè§€éŸ³'}
  };
  alert(hints[locationNum][Math.min(hintCounters[locationNum],3)]);
  if(hintCounters[locationNum]===3){
    setTimeout(function(){ hintCounters[locationNum]=0; document.getElementById('hint-count-'+locationNum).textContent='0'; },2000);
  }
}

function showVideo(locationNum,type){
  const videoInfo={
    1:{history:{title:'ä¹é¾å¯¨åŸæ­·å²',youtubeId:'dQw4w9WgXcQ'},story:{title:'ä¹é¾å¯¨åŸæ•…äº‹é€²åº¦',youtubeId:'dQw4w9WgXcQ'}},
    2:{history:{title:'åä¸‰è¡—èˆŠæ¨“ç¾¤æ•…äº‹',youtubeId:'dQw4w9WgXcQ'},story:{title:'åä¸‰è¡—ç™¼å±•æ•…äº‹',youtubeId:'dQw4w9WgXcQ'}},
    3:{history:{title:'ç‰›æ£šè—è¡“æ‘è½‰å‹',youtubeId:'dQw4w9WgXcQ'},story:{title:'ç‰›æ£šè—è¡“æ‘æ•…äº‹',youtubeId:'dQw4w9WgXcQ'}},
    4:{history:{title:'æµ·å¿ƒå…¬åœ’èˆ‡é­šå°¾çŸ³å‚³èªª',youtubeId:'dQw4w9WgXcQ'},story:{title:'æµ·å¿ƒå…¬åœ’æ•…äº‹',youtubeId:'dQw4w9WgXcQ'}},
    5:{history:{title:'å®‹çš‡è‡ºæ­·å²éºè·¡',youtubeId:'dQw4w9WgXcQ'},story:{title:'å®‹çš‡è‡ºæ•…äº‹',youtubeId:'dQw4w9WgXcQ'}},
    6:{history:{title:'ç´…ç£¡è§€éŸ³å»Ÿæ–‡åŒ–',youtubeId:'dQw4w9WgXcQ'},story:{title:'ç´…ç£¡è§€éŸ³å»Ÿæ•…äº‹',youtubeId:'dQw4w9WgXcQ'}}
  };
  const info=videoInfo[locationNum][type];
  document.getElementById('video-title').textContent=info.title;
  document.getElementById('video-description').textContent=info.title;
  document.getElementById('video-player').src='https://www.youtube.com/embed/'+info.youtubeId+'?autoplay=1&rel=0';
  document.getElementById('video-modal').style.display='flex';
}
function closeVideo(){
  document.getElementById('video-modal').style.display='none';
  document.getElementById('video-player').src='';
}
function completeGame(){
  for(let i=1;i<=totalLocations;i++) document.getElementById('location-'+i).style.display='none';
  document.getElementById('completion').style.display='block';
  updateProgress();
}
function resetGame(){
  for(let i=2;i<=totalLocations;i++) document.getElementById('location-'+i).style.display='none';
  document.getElementById('completion').style.display='none';
  document.getElementById('location-1').style.display='block';
  currentLocation=1;
  updateProgress();
  for(let i=1;i<=totalLocations;i++){
    document.getElementById('answer-'+i).value='';
    hintCounters[i]=0;
    document.getElementById('hint-count-'+i).textContent='0';
  }
}

/* ================= GPS è·é›¢ & è‡ªæ‹ ç¶­æŒåŸæ¨£ ================= */
const HERE = { lat: 22.317212, lng: 114.167039 };
const POIS = [
  {id:1, name:'ä¹é¾å¯¨åŸå…¬åœ’',  lat:HERE.lat + 0.00080, lng:HERE.lng + 0.00080},
  {id:2, name:'åä¸‰è¡—èˆŠæ¨“ç¾¤', lat:HERE.lat - 0.00090, lng:HERE.lng + 0.00090},
  {id:3, name:'ç‰›æ£šè—è¡“æ‘',   lat:HERE.lat + 0.00100, lng:HERE.lng - 0.00070},
  {id:4, name:'æµ·å¿ƒå…¬åœ’',     lat:HERE.lat - 0.00110, lng:HERE.lng - 0.00060},
  {id:5, name:'å®‹çš‡è‡ºå…¬åœ’',   lat:HERE.lat + 0.00120, lng:HERE.lng + 0.00120},
  {id:6, name:'ç´…ç£¡è§€éŸ³å»Ÿ',   lat:HERE.lat - 0.00130, lng:HERE.lng + 0.00130}
];
const VIDEOS={1:{story:'dQw4w9WgXcQ',hist:'dQw4w9WgXcQ'},2:{story:'AAA',hist:'BBB'},3:{story:'CCC',hist:'DDD'},4:{story:'EEE',hist:'FFF'},5:{story:'GGG',hist:'HHH'},6:{story:'III',hist:'JJJ'}};
const TRIGGER_M = 200;
const player  = document.getElementById('gpsPlayer');
const overlay = document.getElementById('gpsVideo');
const prompt  = document.getElementById('gpsPrompt');
let promptShownSet = new Set();

/* âœ… ä¿®å¾©ï¼šæ”¹ç”¨ Math.pow() å…¼å®¹æ‰€æœ‰ç€è¦½å™¨ */
function dist(a,b){
  const R=6371000, toRad=function(d){return d*Math.PI/180;};
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const la1=toRad(a.lat), la2=toRad(b.lat);
  return 2*R*Math.asin(Math.sqrt(
    Math.pow(Math.sin(dLat/2),2) + 
    Math.cos(la1)*Math.cos(la2)*Math.pow(Math.sin(dLng/2),2)
  ));
}

function closePrompt(){ prompt.style.display='none'; }
function playSelected(type){
  const id=Number(prompt.dataset.poiId);
  overlay.style.display='block';
  player.src='https://www.youtube.com/embed/'+VIDEOS[id][type]+'?autoplay=1&rel=0';
  closePrompt();
  setTimeout(function(){ overlay.style.display='none'; player.src=''; },20000);
}
function watchGPS(){
  navigator.geolocation.watchPosition(
    function(pos){
      const here={lat:pos.coords.latitude, lng:pos.coords.longitude};
      POIS.forEach(function(p){
        const d=Math.round(dist(here,p));
        const badge=document.getElementById('dist-'+p.id);
        if(badge) badge.textContent=d<1000?d+' m':(d/1000).toFixed(1)+' km';
        if(d<TRIGGER_M && !promptShownSet.has(p.id)){
          promptShownSet.add(p.id);
          prompt.dataset.poiId=p.id;
          document.getElementById('promptPoiName').textContent=p.name;
          prompt.style.display='block';
        }
      });
    },
    function(err){alert('GPS éŒ¯èª¤ï¼š'+err.message);},
    {enableHighAccuracy:true, maximumAge:5000}
  );
}
window.addEventListener('load',function(){
  if(navigator.geolocation) watchGPS();
  else alert('è£ç½®ä¸æ”¯æ´ GPSï¼Œç„¡æ³•ä½¿ç”¨è·é›¢èˆ‡å½±ç‰‡æç¤ºã€‚');
  updateProgress();
});

/* ---- è‡ªæ‹åŠŸèƒ½ ---- */
function takeSelfie(locationNum){
  const canvas=document.getElementById('canvas-'+locationNum);
  const ctx=canvas.getContext('2d');
  const img=document.getElementById('selfie-'+locationNum);
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,600,600);
  ctx.fillStyle='#000000'; ctx.font='bold 48px Arial'; ctx.textAlign='center';
  const site=locationNum===0?'ä¹é¾åŸåœŸç“œç£æ¢ç´¢':POIS.find(function(p){return p.id===locationNum;}).name;
  ctx.fillText('æˆ‘å·²å®Œæˆã€'+site+'ã€‘ä»»å‹™ï¼',300,300);
  navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false})
  .then(function(stream){
    const video=document.createElement('video'); video.srcObject=stream; video.play();
    video.addEventListener('loadedmetadata',function(){
      ctx.drawImage(video,150,350,300,200);
      stream.getTracks().forEach(function(t){t.stop();});
      const dataURL=canvas.toDataURL('image/jpeg',0.9);
      img.src=dataURL; img.style.display='block';
      window.location.href='https://wa.me/85266837444?text='+encodeURIComponent('æˆ‘å·²å®Œæˆã€'+site+'ã€‘ä»»å‹™ï¼');
    });
  })
  .catch(function(err){alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚'); console.error(err);});
}
</script>
</body>
</html>
